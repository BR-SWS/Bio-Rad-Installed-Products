<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Installed Product Search</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #search-container {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    input[type="text"] {
      margin-bottom: 10px;
      padding: 5px;
      width: 300px;
    }

    button {
      padding: 5px 10px;
      margin-left: 10px;
      cursor: pointer;
    }

    #tableContainerWrapper {
      width: 100%;
      position: relative;
    }

    #tableContainer {
      overflow-x: auto;
      width: 100%;
      max-height: 70vh;
    }

    table {
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
      table-layout: auto;
    }

    th, td {
      padding: 8px;
      text-align: center;
      border: 1px solid #ddd;
      font-size: 12px;
      white-space: normal;
      word-wrap: break-word;
    }

    th {
      background-color: #4caf50;
      color: white;
      font-size: 16px;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tr:nth-child(odd) {
      background-color: #f2f2f2;
    }

    .filter-row input {
      width: 100%;
      box-sizing: border-box;
      padding: 4px;
    }

    #paginationControls {
      margin-top: 15px;
    }

    #paginationControls button {
      padding: 5px 10px;
      margin: 0 5px;
    }
  </style>
</head>
<body>

  <h2>Search Installed Products</h2>
  <div id="search-container">
    <input type="text" id="searchInput" placeholder="Search Installed Products...">
    <button id="clearFiltersBtn">Clear All Filters</button>
  </div>

  <div id="tableContainerWrapper">
    <div id="tableContainer"></div>
  </div>

  <div id="paginationControls"></div>

  <script>
    const fileUrl = 'https://raw.githubusercontent.com/BR-SWS/Bio-Rad-Installed-Products/main/InstalledProducts.xlsx';
    let originalData = [];
    let filteredData = [];
    let currentPage = 1;
    const rowsPerPage = 20;
    let columnFilters = [];

    fetch(fileUrl)
      .then(response => response.arrayBuffer())
      .then(data => {
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const headerRow = jsonData[0];
        const dateInstalledIndex = headerRow.findIndex(cell =>
          typeof cell === 'string' && cell.trim().toLowerCase().includes('date installed')
        );

        if (dateInstalledIndex !== -1) {
          jsonData.slice(1).forEach(row => {
            const excelDate = row[dateInstalledIndex]+1;
            if (typeof excelDate === 'number') {
              row[dateInstalledIndex] = excelDateToJSDate(excelDate).toLocaleDateString();
            }
          });
        }

        originalData = jsonData;
        filteredData = jsonData.slice(1);
        columnFilters = new Array(originalData[0].length).fill('');
        renderTable();
        renderPaginationControls();
      })
      .catch(error => console.error('Error fetching or parsing the Excel file:', error));

    function excelDateToJSDate(excelDate) {
      return new Date((excelDate - 25569) * 86400000);
    }

    function renderTable() {
      const tableContainer = document.getElementById('tableContainer');
      const table = document.createElement('table');
      const thead = table.createTHead();
      const tbody = table.createTBody();
      tableContainer.innerHTML = '';

      // Header row
      const headerRow = thead.insertRow();
      originalData[0].forEach(cell => {
        const th = document.createElement('th');
        th.textContent = cell;
        headerRow.appendChild(th);
      });

      // Filter row (always shown now)
      const filterRow = thead.insertRow();
      filterRow.classList.add('filter-row');
      originalData[0].forEach((_, colIndex) => {
        const th = document.createElement('th');
        const input = document.createElement('input');
        input.setAttribute('list', `column-filter-list-${colIndex}`);
        input.placeholder = 'Type or select a value...';

        const datalist = document.createElement('datalist');
        datalist.id = `column-filter-list-${colIndex}`;

        const columnValues = getColumnUniqueValues(colIndex);
        columnValues.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          datalist.appendChild(option);
        });

        input.value = columnFilters[colIndex] || '';

        const handleFilterChange = () => {
          columnFilters[colIndex] = input.value;
          applyAllFilters();
        };
        input.oninput = debounce(handleFilterChange, 200);
        input.onchange = handleFilterChange;

        th.appendChild(input);
        th.appendChild(datalist);
        filterRow.appendChild(th);
      });

      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = filteredData.slice(start, end);

      pageData.forEach(row => {
        const tr = tbody.insertRow();
        row.forEach(cell => {
          const td = tr.insertCell();
          td.textContent = cell !== undefined ? cell : '';
        });
      });

      tableContainer.appendChild(table);
    }

    function getColumnUniqueValues(colIndex) {
      const values = new Set();
      filteredData.forEach(row => {
        if (row[colIndex] !== undefined) {
          values.add(row[colIndex]);
        }
      });
      return Array.from(values);
    }

    function applyAllFilters() {
      const input = document.getElementById('searchInput').value.toLowerCase().trim();

      filteredData = originalData.slice(1).filter(row => {
        const matchesGlobal = row.some(cell => String(cell).toLowerCase().includes(input));
        const matchesColumns = columnFilters.every((filter, index) => {
          if (!filter) return true;
          return String(row[index] || '').toLowerCase().includes(filter.toLowerCase());
        });
        return matchesGlobal && matchesColumns;
      });

      currentPage = 1;
      renderTable();
      renderPaginationControls();
    }

    function renderPaginationControls() {
      const pagination = document.getElementById('paginationControls');
      const totalPages = Math.ceil(filteredData.length / rowsPerPage);
      pagination.innerHTML = `
        <button onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
        Page ${currentPage} of ${totalPages}
        <button onclick="changePage(1)" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
      `;
    }

    function changePage(delta) {
      const totalPages = Math.ceil(filteredData.length / rowsPerPage);
      currentPage = Math.min(Math.max(1, currentPage + delta), totalPages);
      renderTable();
      renderPaginationControls();
    }

    function debounce(fn, delay) {
      let timer;
      return function (...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    document.getElementById('searchInput').addEventListener('input', debounce(applyAllFilters, 200));

    document.getElementById('clearFiltersBtn').addEventListener('click', () => {
      document.getElementById('searchInput').value = '';
      columnFilters = new Array(originalData[0].length).fill('');
      filteredData = originalData.slice(1);
      currentPage = 1;
      renderTable();
      renderPaginationControls();
    });
  </script>

</body>
</html>
